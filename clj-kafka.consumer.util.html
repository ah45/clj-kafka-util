<!DOCTYPE html>
<html><head><meta charset="UTF-8"><link href="css/default.css" rel="stylesheet" type="text/css"><script src="js/jquery.min.js" type="text/javascript"></script><script src="js/page_effects.js" type="text/javascript"></script><title>clj-kafka.consumer.util documentation</title></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Clj-kafka-util</span> <span class="project-version">0.1.0</span></span></a></h1></div><div class="sidebar primary"><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clj-kafka</span></div></div></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>consumer</span></div></div></li><li class="depth-3 current"><a href="clj-kafka.consumer.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="clj-kafka.consumer.util.html#var-default-read-all-timeout-ms"><div class="inner"><span>default-read-all-timeout-ms</span></div></a></li><li class="depth-1"><a href="clj-kafka.consumer.util.html#var-read-all-from-topic"><div class="inner"><span>read-all-from-topic</span></div></a></li><li class="depth-1"><a href="clj-kafka.consumer.util.html#var-string-decoder"><div class="inner"><span>string-decoder</span></div></a></li><li class="depth-1"><a href="clj-kafka.consumer.util.html#var-topic-.3Emap"><div class="inner"><span>topic-&gt;map</span></div></a></li><li class="depth-1"><a href="clj-kafka.consumer.util.html#var-topic-.3Ereduceable"><div class="inner"><span>topic-&gt;reduceable</span></div></a></li><li class="depth-1"><a href="clj-kafka.consumer.util.html#var-topic-onto-chan"><div class="inner"><span>topic-onto-chan</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">clj-kafka.consumer.util</h1><div class="doc"><div class="markdown"></div></div><div class="public anchor" id="var-default-read-all-timeout-ms"><h3>default-read-all-timeout-ms</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>The default <code>consumer.timeout.ms</code> value used when creating Kafka consumers: 30 milliseconds.</p></div></div><div class="src-link"><a href="https://github.com/ah45/clj-kafka-util/blob/master/src/clj_kafka/consumer/util.clj#L11">view source</a></div></div><div class="public anchor" id="var-read-all-from-topic"><h3>read-all-from-topic</h3><div class="usage"><code>(read-all-from-topic topic kafka-config)</code><code>(read-all-from-topic topic kafka-config key-decoder value-decoder)</code></div><div class="doc"><div class="markdown"><p>Returns a collection of all messages readable from the specified topic up to the point when no new messages arrive inside <code>consumer.timeout.ms</code> of reading the last message.</p></div></div><div class="src-link"><a href="https://github.com/ah45/clj-kafka-util/blob/master/src/clj_kafka/consumer/util.clj#L209">view source</a></div></div><div class="public anchor" id="var-string-decoder"><h3>string-decoder</h3><div class="usage"><code>(string-decoder)</code></div><div class="doc"><div class="markdown"><p>Returns a new <code>StringDecoder</code> instance.</p></div></div><div class="src-link"><a href="https://github.com/ah45/clj-kafka-util/blob/master/src/clj_kafka/consumer/util.clj#L19">view source</a></div></div><div class="public anchor" id="var-topic-.3Emap"><h3>topic-&gt;map</h3><div class="usage"><code>(topic-&gt;map topic kafka-config)</code><code>(topic-&gt;map topic kafka-config key-decoder value-decoder)</code></div><div class="doc"><div class="markdown"><p>Returns a map of all messages able to be read from the specified topic up to the point when no new messages arrive inside <code>consumer.timeout.ms</code> of reading the last message.</p>
<p>This is a simple wrapper over <code>topic-&gt;reduceable</code> that builds a map of <code>{message-key message-value}</code>, returning a map of the last read values for each key.</p></div></div><div class="src-link"><a href="https://github.com/ah45/clj-kafka-util/blob/master/src/clj_kafka/consumer/util.clj#L192">view source</a></div></div><div class="public anchor" id="var-topic-.3Ereduceable"><h3>topic-&gt;reduceable</h3><div class="usage"><code>(topic-&gt;reduceable topic kafka-config)</code><code>(topic-&gt;reduceable topic kafka-config key-decoder value-decoder)</code></div><div class="doc"><div class="markdown"><p>Returns a reduceable collection that, when reduced, consumes all messages from the specified topic until no more arrive within <code>consumer.timeout.ms</code> of reading the last message (defaulting to <code>default-read-all-timeout-ms</code>.)</p>
<p>If you&rsquo;ve ever wanted to treat a Kafka topic as a reduceable/transducable collection then this is the function for you.</p>
<pre><code>;; build map of messages from a topic
(reduce
  (fn [rs m]
    (assoc rs (.key m) (.message m)))
  {}
  (topic-&gt;reduceable &quot;my_topic&quot; kafka-config))

;; collect all message up to a known offset
(let [max-offset 100]
  ;; via reduction
  (reduce
    (fn [rs m]
      (cond
        (&gt; (.offset m) max-offset) (reduced rs)
        (= (.offset m) max-offset) (reduced (conj rs m))
        :else (conj rs m)))
    []
    (topic-&gt;reduceable &quot;my_topic&quot; kafka-config)))
  ;; or transduction (simpler!)
  (transduce
    (take-while #(&lt;= (.offset %) max-offset))
    conj []
    (topic-&gt;reduceable &quot;my_topic&quot; kafka-config))

;; get the content of the next 100 messages
(transduce
  (comp (take 100)
        (map #(.message %)))
  conj []
  (topic-&gt;reduceable &quot;my_topic&quot; kafka-config))
</code></pre>
<p><strong>Q:</strong> How does this differ from running a transducer over the message stream?</p>
<p><strong>A:</strong> It provides two benefits:</p>
<ol>
  <li>It gracefully handles reaching the “end” of the messages  currently posted to the topic (if using a consumer timeout.)</li>
  <li>Abstracts away the creation of the consumer and stream so that  you can easily substitute the topic for a collection and  vice/versa just by replacing a single s-expression.</li>
</ol>
<p>Arguments:</p>
<ul>
  <li><code>topic</code>, the name of the Kafka topic to consume.</li>
  <li><code>kafka-config</code>, a map of Kafka connection properties suitable for  passing to <code>clj-kafka.consumer/consumer</code> to create a consumer.</li>
  <li><code>key-decoder</code>, an optional decoder to use for decoding the message  keys. Will use <code>clj-kafka.consumer/default-decoder</code> if not  specified.</li>
  <li><code>value-decoder</code>, an optional decoder to use for decoding the message  values. Will use <code>clj-kafka.consumer/default-decoder</code> if not  specified.</li>
</ul>
<p><strong>Important:</strong> either the stream of messages from Kafka must <em>end</em> at some point or the reduction must reach a <code>reduced?</code> state; if not the reduction on the collection <em>will</em> block forever and never return.</p>
<p>By default the created consumer handles this by setting the <code>&quot;consumer.timeout.ms&quot;</code> property, to force the reduction to end when no new messages are received within a short period. Be aware that this may not work if you have a particularly fast moving topic.</p>
<p>If you set the timeout yourself then, as a guideline, it should be less than the average time between message receipts for the topic.</p>
<p>If you <em>want</em> the reduction to run forever (e.g. when performing stream processing via transduction) then you will need to set the <code>&quot;consumer.timeout.ms&quot;</code> to <code>&quot;-1&quot;</code>.</p>
<p>As with any other reduction you can stop the reduction at any time by returning a <code>reduced</code> value from your reducer function.</p></div></div><div class="src-link"><a href="https://github.com/ah45/clj-kafka-util/blob/master/src/clj_kafka/consumer/util.clj#L64">view source</a></div></div><div class="public anchor" id="var-topic-onto-chan"><h3>topic-onto-chan</h3><div class="usage"><code>(topic-onto-chan ch topic kafka-config)</code><code>(topic-onto-chan ch topic kafka-config close?)</code><code>(topic-onto-chan ch topic kafka-config key-decoder value-decoder)</code><code>(topic-onto-chan ch topic kafka-config key-decoder value-decoder close?)</code></div><div class="doc"><div class="markdown"><p>Consumes from <code>topic</code> and posts received messages to channel <code>ch</code>.</p>
<p>Returns a <code>java.io.Closeable</code> that, when <code>.close</code>d, shuts down the associated Kafka consumer and, if <code>close?</code> is <code>true</code> (the default) closes <code>ch</code>.</p>
<p>Arguments:</p>
<ul>
  <li><code>topic</code>, the name of the Kafka topic to consume.</li>
  <li><code>kafka-config</code>, a map of Kafka connection properties suitable for  passing to <code>clj-kafka.consumer/consumer</code> to create a consumer.</li>
  <li><code>key-decoder</code>, an optional decoder to use for decoding the message  keys. Will use <code>clj-kafka.consumer/default-decoder</code> if not  specified.</li>
  <li><code>value-decoder</code>, an optional decoder to use for decoding the message  values. Will use <code>clj-kafka.consumer/default-decoder</code> if not  specified.</li>
  <li><code>close?</code>, a boolean dictating whether or not to close <code>ch</code> when we  close. Defaults to <code>true</code>.</li>
</ul></div></div><div class="src-link"><a href="https://github.com/ah45/clj-kafka-util/blob/master/src/clj_kafka/consumer/util.clj#L24">view source</a></div></div></div></body></html>